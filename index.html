<!DOCTYPE html>
<html>
<head>
    <title>ZEBRA TAG - PRO EDITION</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 20px; transition: background 0.1s; }
        #status-container { position: fixed; top: 10px; right: 10px; font-size: 0.7rem; background: #111; padding: 8px; border: 1px solid #333; z-index: 1000; }
        .score-row { border: 1px solid #0f0; width: 95%; max-width: 400px; padding: 15px; display: flex; justify-content: space-between; font-size: 1.5rem; margin: 10px auto; }
        #login-screen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .description { color: #888; font-size: 0.9rem; max-width: 320px; margin-bottom: 25px; line-height: 1.4; }
        #username-input { background: #111; color: #0f0; border: 2px solid #0f0; padding: 15px; font-size: 1.5rem; text-align: center; outline: none; }
        #scanner { position: absolute; left: -9999px; opacity: 0; }
        button { background: #0f0; color: #000; border: none; padding: 15px 30px; font-weight: bold; cursor: pointer; }
        #operator-display { color: white; margin-bottom: 20px; font-size: 1.2rem; }
        .invalid-flash { background: #300 !important; }
    </style>
</head>
<body>

    <div id="status-container">NETWORK: <span id="status-text" style="color:orange">CONNECTING...</span></div>

    <div id="login-screen">
        <h1>ZEBRA TAG PRO</h1>
        <div class="description">
            Scan official <b>SHP</b> stickers to log progress. Press [SPACE] for manual override.
        </div>
        <input type="text" id="username-input" placeholder="OPERATOR NAME..." autocomplete="off">
        <button onclick="joinGame()" style="margin-top: 20px;">START ENGINE</button>
    </div>

    <div id="game-ui" style="display:none;">
        <div id="operator-display"></div>
        <div id="board"></div>
        <button onclick="resetScores()" style="background:red; color:white; margin-top:40px; font-size: 0.7rem;">WIPE GLOBAL DATA</button>
    </div>

    <input type="text" id="scanner">

    <script>
        // 2. YOUR FIREBASE KEYS (Plugged in for you!)
        const firebaseConfig = {
            apiKey: "AIzaSyDFIuHkzGlTNn20-2hVyQUwaKXyqZ9kPRc",
            authDomain: "zebratagpro.firebaseapp.com",
            projectId: "zebratagpro",
            databaseURL: "https://zebratagpro-default-rtdb.firebaseio.com/", // Verify this in your console!
            storageBucket: "zebratagpro.firebasestorage.app",
            messagingSenderId: "202574491794",
            appId: "1:202574491794:web:a29bdf5a66f44a1cd1764b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let myName = localStorage.getItem('zebraUser') || "";
        let gameStarted = false; 

        document.getElementById('username-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });

        async function joinGame() {
            const val = document.getElementById('username-input').value.trim().toUpperCase();
            if (val) {
                localStorage.setItem('zebraUser', val);
                myName = val;
                bootGame();
            } else { alert("Enter Name"); }
        }

        function bootGame() {
            gameStarted = true; 
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('operator-display').innerText = "OPERATOR: " + myName;
            document.getElementById('status-text').innerText = "ONLINE";
            document.getElementById('status-text').style.color = "#0f0";

            // REAL-TIME LISTENER: Updates board whenever ANYONE scans
            db.ref('scores').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                render(data);
            });
            
            setTimeout(() => document.getElementById('scanner').focus(), 500);
        }

        function iScored() {
            // Uses a 'transaction' to ensure counts don't get messed up if two people scan at once
            db.ref('scores/' + myName).transaction((current) => {
                return (current || 0) + 1;
            });

            // FEEDBACK
            if (navigator.vibrate) navigator.vibrate(200); 
            document.body.style.background = "#030";
            setTimeout(() => document.body.style.background = "#000", 100);
        }

        function render(playerScores) {
            const b = document.getElementById('board');
            b.innerHTML = '';
            const sorted = Object.keys(playerScores).sort((a,b) => playerScores[b] - playerScores[a]);
            sorted.forEach(id => {
                const isMe = id === myName ? "style='border: 2px solid #fff;'" : "";
                b.innerHTML += `<div class="score-row" ${isMe}><span>${id}</span><span>${playerScores[id]}</span></div>`;
            });
        }

        function resetScores() {
            if(confirm("Wipe all scores globally?")) {
                db.ref('scores').remove();
            }
        }

        // SCANNER LOGIC
        document.addEventListener('keydown', (e) => { 
            if(!gameStarted) return; 
            if(e.code === "Space") { e.preventDefault(); iScored(); }
            document.getElementById('scanner').focus(); 
        });

        document.getElementById('scanner').addEventListener('change', (e) => { 
            const val = e.target.value.trim().toUpperCase();
            if(val.startsWith("SHP")) { 
                iScored(); 
            } else if (val !== "") {
                document.body.classList.add('invalid-flash');
                setTimeout(() => document.body.classList.remove('invalid-flash'), 100);
            }
            e.target.value = ''; 
        });

        setInterval(() => { if(gameStarted) document.getElementById('scanner').focus(); }, 1000);
        if(myName) bootGame();
    </script>
</body>
</html>
