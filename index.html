<!DOCTYPE html>
<html>
<head>
    <title>ZEBRA TAG - PRO EDITION</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 20px; }
        #status-container { position: fixed; top: 10px; right: 10px; font-size: 0.7rem; background: #111; padding: 8px; border: 1px solid #333; z-index: 1000; }
        .score-row { border: 1px solid #0f0; width: 95%; max-width: 400px; padding: 15px; display: flex; justify-content: space-between; font-size: 1.5rem; margin: 10px auto; }
        #login-screen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #username-input { background: #111; color: #0f0; border: 2px solid #0f0; padding: 15px; font-size: 1.5rem; text-align: center; }
        #scanner { position: absolute; left: -9999px; opacity: 0; }
        button { background: #0f0; color: #000; border: none; padding: 15px; font-weight: bold; cursor: pointer; }
        #operator-display { color: white; margin-bottom: 20px; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="status-container">NETWORK: <span id="status-text" style="color:orange">CONNECTING...</span></div>

    <div id="login-screen">
        <h1>ZEBRA TAG PRO</h1>
        <input type="text" id="username-input" placeholder="OPERATOR NAME...">
        <button onclick="joinGame()" style="margin-top: 20px;">START ENGINE</button>
    </div>

    <div id="game-ui" style="display:none;">
        <div id="operator-display"></div>
        <div id="board"></div>
        <button onclick="resetScores()" style="background:red; color:white; margin-top:40px; font-size: 0.7rem;">WIPE GLOBAL DATA</button>
    </div>

    <input type="text" id="scanner" autofocus>

    <script>
        // 1. YOUR SUPABASE CONFIG (Paste your keys below)
        const SUPABASE_URL = 'https://awstxoaxwsrhcfimunca.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_aZH46m2lP5s6KFeXrZ1gdA_MFNQROnW';
        
        // Initialize the client
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let myName = localStorage.getItem('zebraUser') || "";
        let playerScores = {};

        async function joinGame() {
            const val = document.getElementById('username-input').value.trim().toUpperCase();
            if (val) {
                localStorage.setItem('zebraUser', val);
                myName = val;
                bootGame();
            } else {
                alert("Enter Name");
            }
        }

        async function bootGame() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('operator-display').innerText = "OPERATOR: " + myName;

            // Update Status
            document.getElementById('status-text').innerText = "ONLINE";
            document.getElementById('status-text').style.color = "#0f0";

            // A. Initial Data Fetch
            const { data, error } = await _supabase.from('scores').select('*');
            if (data) {
                data.forEach(row => playerScores[row.username] = row.score);
                render();
            }

            // B. Real-time Subscription (This makes the leaderboard move live!)
            _supabase.channel('custom-all-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'scores' }, payload => {
                    if (payload.new) {
                        playerScores[payload.new.username] = payload.new.score;
                        render();
                    }
                    if (payload.eventType === 'DELETE') {
                        // Refresh data if someone wipes the board
                        location.reload();
                    }
                }).subscribe();
            
            // C. Register our presence/Initial Score
            await _supabase.from('scores').upsert({ 
                username: myName, 
                score: playerScores[myName] || 0 
            });
            
            document.getElementById('scanner').focus();
        }

        async function iScored() {
            let current = (playerScores[myName] || 0) + 1;
            playerScores[myName] = current; // Optimistic update for speed
            render();

            // Send hit to Supabase
            const { error } = await _supabase.from('scores').upsert({ 
                username: myName, 
                score: current 
            });

            // Feedback Flash
            document.body.style.background = "#030";
            setTimeout(() => document.body.style.background = "#000", 100);
        }

        function render() {
            const b = document.getElementById('board');
            b.innerHTML = '';
            
            // Sort by highest score
            const sorted = Object.keys(playerScores).sort((a,b) => playerScores[b] - playerScores[a]);
            
            sorted.forEach(id => {
                const isMe = id === myName ? "style='border: 2px solid #fff;'" : "";
                b.innerHTML += `<div class="score-row" ${isMe}><span>${id}</span><span>${playerScores[id]}</span></div>`;
            });
        }

        async function resetScores() {
            if(confirm("DANGER: This wipes scores for EVERYONE. Continue?")) {
                await _supabase.from('scores').delete().neq('username', 'placeholder_garbage_value');
                playerScores = {};
                render();
            }
        }

        // Controls: Spacebar and Scanner Input
        document.addEventListener('keydown', (e) => { 
            if(e.code === "Space") {
                e.preventDefault();
                iScored(); 
            }
            document.getElementById('scanner').focus(); 
        });

        document.getElementById('scanner').addEventListener('change', (e) => { 
            if(e.target.value.trim()) { 
                iScored(); 
                e.target.value = ''; 
            } 
        });

        // Auto-focus helper
        setInterval(() => {
            if(document.getElementById('game-ui').style.display === 'block') {
                document.getElementById('scanner').focus();
            }
        }, 1000);

        // Auto-boot if name exists
        if(myName) bootGame();
    </script>
</body>
</html>
